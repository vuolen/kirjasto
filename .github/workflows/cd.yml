name: Continuous Deployment

on:
  push:
    branches: [ main ]
  repository_dispatch:
    types: [frontend_push, backend_push]
 
env:
  FRONTEND_LOCATION: ./kirjasto-frontend
  BACKEND_LOCATION: ./kirjasto-backend

jobs:
  checkout:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout kirjasto
        uses: actions/checkout@v2
        
      - name: Checkout frontend
        uses: actions/checkout@v2
        with:
          repository: vuolen/kirjasto-frontend
          path: kirjasto-frontend
          
      - name: Checkout backend
        uses: actions/checkout@v2
        with:
          repository: vuolen/kirjasto-backend
          path: kirjasto-backend
          
      - name: Cache workspace
        uses: actions/cache@v2
        id: workspace
        with:
          path: $GITHUB_WORKSPACE
          key: workspace-cache-key
    
  e2e_test:
    runs-on: ubuntu-latest
    needs: checkout
    
    env:
      BACKEND_URL: backend:8000
      POSTGRES_PASSWORD: e2etest

    steps:
      - run: docker-compose -f e2e.yml run e2e

  
